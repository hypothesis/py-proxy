proxy_ssl_server_name on;

# Remove any query params from $uri (we'll put them back later).
rewrite ^(.*)$ $1?;

# Redirect Google Drive requests to the API using our key
#
# Some weird things:
# * A rule that starts with http will _immediately_ issue a proxy_redirect
# * So we seemingly pointlessly capture (https) and replace it
# * This way the _result_ starts with https, but the _rule_ doesn't and we can carry on
rewrite ^(https)://drive.google.com/uc\?id=(.*)&export=download$ $1://www.googleapis.com/drive/v3/files/$2?key=$google_api_key&alt=media;

break;

# The proxy directly to the resulting URL
# Add back on the args which we stripped above so we don't get them twice
proxy_pass $uri$is_args$args;

# Strip hypothesis cookies and authorization header.
set $stripped_cookie $http_cookie;

if ($stripped_cookie ~ "(.*)\s*auth=[^;]+;?(.*)") {
    set $stripped_cookie $1$2;
}
if ($stripped_cookie ~ "(.*)\s*session=[^;]+;?(.*)") {
    set $stripped_cookie $1$2;
}
proxy_set_header Cookie $stripped_cookie;
proxy_set_header Authorization "";

# Do not allow the third party server to set cookies.
add_header "Set-Cookie" "";

# Prevent the third party from adding CORS controls
proxy_hide_header "Access-Control-Allow-Origin";
proxy_hide_header "Access-Control-Allow-Credentials";
proxy_hide_header "Access-Control-Allow-Methods";
proxy_hide_header "Access-Control-Allow-Headers";
proxy_hide_header "Access-Control-Expose-Headers";
